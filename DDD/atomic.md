---
layout: ddd
prev: command.html
---
# 原子操作 vs 聚合操作 

按照CQRS模式，我们区分“命令”、“查询”，命令是修改实体状态，更新领域数据的操作，在实际的业务中，我们需要进一步的区分为：
- 原子操作。是领域模型中的“最小粒度”的操作，其不可再进行分解（或者进一步分解不再有实际价值）。同时，原子操作存在的最大意义是可以“组合”成更多的复杂操作。
    
  以银行账户为例，典型的原子操作包括：
  - 存款：账户余额增加，同时记录存款流水。
  - 取款：账户余额减少。同时记录取款流水。
  
  由于银行账户不仅维护账户余额，还需要按照一定的规则进行利息计算，以活期存款为例，一般的，银行是按照“利息积数“的方式，维护这一个账户的”最近积数调整日期、最近累计积数”的概念来累计利息积数。无论是存款、取款，都需要更新这两个值
  1. 最近积数调整日期 = 当前交易日期
  2. 最近累计积数 = old(最近累计积数) + old(账户余额）* (当前交易日期 - old(最近积数调整日期）
  3. 账户余额 = old(账户余额） +/- 交易金额。
  
  在这个例子中，我们将 存款（deposit)、取款（withdraw)作为2个原子操作。
  
- 聚合操作。
  还是以“银行账户”为例，对一个账户，有很多的其他操作
  - 转账。将资金从一个账户转到另外一个账户。这个转账包括
      - 同一用户名下的账户间转账
      - 同一个系统之间的账户间转账（行内转账）
      - 跨行转账。
  - 结息。将利息作为本金存入账户。
  - POS消费。
  - 网上支付
  - 缴纳账户年金
  
  随着业务的不断发展（创新），这写操作还会不断的扩展，这些操作并不完全等同与“存款”、“取款”，例如，不同的操作会有不同的规则点，例如：
  - 现金取款。每天有2万元的上限检查。
  - 网上支付，有每天的支付上限和每月的支付上限（以保证用户资金安全）。
  
- 