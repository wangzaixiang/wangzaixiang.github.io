---
layout: ddd
prev: microservice.html
up: about-ddd.html
next: 
---

# 实体 

在 Eric 的《Domain Driven Deisgn - Tracking Complexity In The Heart Of Software》一书中，是这样来描述 Entity 这个概念的：

1. Entity 又称之为 Reference Object
2. 一个 Entity 并不仅仅由它的属性所定义，它实际上表示了一个跨越生命周期的“标识线" A Thread of identity
3. 有“唯一”的ID。即使两个人具有相同的名称，只要其具有不同的ID，他就是不同的实体。

当一个业务对象，具有一个“长”（这个长一般是跨单个用户操作的）的生命周期，并且在整个生命周期中，会持续的发生变更，其对外具有“唯一”的标识，那么，这个业务对象就是一个实体。而如果这个业务对象，并不需要一个唯一的标识来进行定位，而是可以使用一个属性集合来描述的话，那么，这个业务对象更适合为一个 Value Object。
1. Entity 有唯一的ID，而Value Object没有。
2. Entity 有生命周期，而 Value Object 没有。

我们以 “用户收货地址” 为例，一个收获地址包括如下信息：
![](media/15710585022569.jpg)

在这里，Address 应该作为 Entity 还是 Value Object 呢？考虑在电商应用中，我们会在下单的过程中，让用户选择某个地址，如果地址发生了变更，还可以编辑改地址，因此，可以看出，在这个过程中，Address 其实有自己的生明周期，而且，用户可以为每一个地址进行命名（以便标识该地址），因此，用户的收货地址应该作为一个 Entity 来进行处理。

每一个“订单”也会对应一个收获地址，那么订单的”收货地址“是否也是一个Entity呢？
1. 每一个“订单”只有一个收货地址。因此，无需为其进行命名。
2. 订单的收货地址在订单创建后，就已经是一个snapshot了，后续如果你继续在“我的收货地址”中修改之前的使用的地址，订单中的收货地址也不应该更新。
    1. 如果要更新订单的收货地址，必须通过订单的售后功能进行变更。这个概念已经不同于”用户收货地址“的变更了。
从这里可以看出，“订单收货地址”是一个没有ID，没有生命周期的对象，就应该作为 Value Object 来处理。

从这个差异可以看出，DDD中的 Entity 与传统的 Entity-Relationship 建模中的实体在概念上是有差异的。在 E-R 建模中并不严格的区分 Entity 和 Value Object，但 DDD 中，Entity 是我们最核心的要素，对应于Domain中的核心业务对象。

## Entity 分析
定义一个业务 Entity，应当考虑如下的因素：
1. 业务领域含义。 这个含义必须是分析师 与 业务人员能够达成一致的。如果一个Entity无法为业务人员所理解，那么这个Entity可能会造成后续巨大的沟通障碍。对业务需求的理解，抽象，以及建立在“行业共识”上的Entity，才是最佳的选择。
    1. 一个 Entity 可能是抽象的，并不一定对应于某个现实存在的对象。每个业务领域，在进入到某个成熟期后，就会冒出一堆抽象的Entity来。比如航空的 Segment，电商的 SKU、SPU、Category等等。
    2. 诸如 会计账户、SKU、Category 等概念，一般已经汇集了多年的运营经验，具备有高度的抽象，并不是简单的提炼。
2. 每个Entity有一个唯一的ID，在整个生命周期中，ID是不变的，并且是定位对象，并进行后续处理的唯一路径。
    1. 物理上的唯一ID。 在很多系统中，会采用系统自动生成的，例如 auto increment、UUID 等作为组件的唯一ID。这种ID没有逻辑上的含义，仅仅用于定位实体。
    2. 逻辑上唯一的ID。比如说，对于身份证来说，我们可以使用用户出生地（6位编码）、生日（8位编码）、出生地顺序号（3位）等来唯一区分一个用户身份，在这里，这个唯一的ID就具有一定的业务含义。这种ID一般是定长的，某些固定位有特定的编码含义，很方便业务人员了解这个ID的一些关键特性。例如机票的前3个数字就是航空公司的编码，银行账号一般也采用类似的编码规范。这种编码的ID，有着便于人员理解的优势，但也相对较长，并不利于数据库进行索引。
    3. 逻辑唯一性。虽然物理ID可以保证其唯一性，但物理ID并不具备业务含义，因此，大部分的实体，仍然需要提供业务唯一性字段，以便我们能够实际区分实体，避免出现重复的情况。例如，注册一个用户时，为了避免出现重复，我们一般需要用户提供手机号码（假定每个用户都有手机号码），由于移动运营商会帮我们保证手机号码的唯一性，因此，我们可以通过手机号码来唯一标识用户。
        1. 我们不能通过“姓名”来唯一区分，同名同姓的几率太大了。
        2. 我们不能使用“手机号码”来作为用户的物理ID，因为用户有很大的几率在一段时间后更换手机号码，而希望保留原有用户资料。
3. 每一个Entity有自己的生命周期，并且在生命周期中，会有很多的业务“操作”，或者说领域操作。识别（或者说定义）实体的生命周期 + 业务操作，是DDD分析的核心内容。[UML 与 DDD](uml.html).
4. 属性列表
    1. 数据类型
    2. 约束
5. 与其它Entity的关系
    1. aggregation
    2. relation(1:1, 1:N, N:1, N:M)
