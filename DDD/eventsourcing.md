# 日志模式与事件溯源

在领域设计时，一个重要的问题是如何存储 Entity 的状态。所有的服务最终都是通过读写 Entity 来完成。Entity的存储构成了复杂系统中“静”的视图，纷繁变化的服务则演绎了"动“的一面。以静制动，确实是简化、抽象的有效工具。传统意义上，Entity对应于关系数据库中的表数据，有唯一的主键（对应于DDD中的唯一ID），每一次的服务访问都可能读、写其状态，或读、写相关联的其它表数据。在这种模式中，Entity的当前状态总是随着时间，在不断的变化，可以理解为一个快照（snapshot)。

Snapshot 模式的一个缺点是丢失了实体的历史信息，这样可能会带来一些问题：
1. 历史信息的丢失。当今是大数据的时代，每一个数据都有其价值，只是暂时未知而已。
2. 不便于溯源。在业务上，也会有溯源的需求。
3. 如果存在数据不一致的情况，难以追溯错误时间点，及其原因。

为了避免信息的丢失，以及溯源的需求，因此，我们会为实体数据，增加变更的日志记录，例如：银行的支付流水，就是账户变更的日志。诸如账户余额、会员积分等，很常见的会设计这一类的日志表。而诸如用户信息、商品信息、订单信息等，则更多采用 Snapshot 的设计模式，如果说，要追溯变更日志，则可能需要查询“日志文件”了，而不是系统中内置的“日志记录"了。

从实战经验来看，采用“日志”表的实体，从整体的数据质量是比较高的，因为实体的信息和日志的信息可以互相印证，如果出现不一致，甚至部分数据丢失的情况，都可能还原出正确的数据出来。数据质量应该是领域设计中需要非常关注的一个维度。但是，使用“日志”表模式，也是有不少的成本，数据存储的量增加可能不是1倍2倍，而是更多，IO也会增加，程序结构也会变得更加复杂了。而且传统的关系数据库，也并不是特别适合于作为“日志”记录，例如，一个20个字段的用户实体，一次可能只变更一个地址、或者电话，这些都不是很适合于使用关系进行存储。

这也是为什么在传统的领域设计中，我们只是对“核心”的领域数据，采用“日志”模式，而对大部分其他的数据，则更倾向于采用 Snapshot 模式。

CQRS 大刀阔斧的对这个进行变革，在CQRS中，我们不再关注于 Entity 的快照存储，而是通过 Command 完成对Entity的变更，变更的结果就是一个 Event，也可以理解为一个"操作日志“，我们存储日志，而不是存储快照。这种模式我也没有真实操刀过，不过，我也赞同，在我们的领域模型设计时，应该尽可能的采用“日志”模式，支持实体的溯源。尤其是对涉及到并发场景下，有复杂的多分枝的计算逻辑的，涉及到资金或者安全相关的信息的，应该采用“日志”记录模式。