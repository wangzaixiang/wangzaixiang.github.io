<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
    div.mermaid {
      width: 0;
    }
</style>

  <link rel="preload" as="font" href="https://wangzaixiang.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="https://wangzaixiang.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2"  type="font/woff2" crossorigin>


<link rel="stylesheet" href="https://wangzaixiang.github.io/main.css">



  
  
  
  
  
    
  

  
  
    
    
  
  
  
    
  
  
  
  
    
  
  
  


  <meta name="robots" content="index, follow">
  <meta name="googlebot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
  <meta name="bingbot" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">


	


	

<title>datafusion 性能分析 | 程序人生</title>
<meta name="description" content="datafusion 性能分析">
<link rel="canonical" href="https://wangzaixiang.github.io/blog/datafusion-performance/">


  <meta name="twitter:card" content="summary_large_image">
  
    <meta name="twitter:image" content="https://wangzaixiang.github.io/doks.png">
  
  <meta name="twitter:title" content="datafusion 性能分析">
  <meta name="twitter:description" content="datafusion 性能分析">
  <meta name="twitter:site" content="@wangzaixiang">
  <meta name="twitter:creator" content="@wangzaixiang">
  
  <meta property="og:title" content="datafusion 性能分析">
  <meta property="og:description" content="datafusion 性能分析">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://wangzaixiang.github.io/blog/datafusion-performance/">

  
    <meta property="og:image" content="https://wangzaixiang.github.io/doks.png">
  

  <meta property="og:updated_time" content="">
  <meta property="og:site_name" content="datafusion 性能分析">

  

  

  
  <meta property="article:publisher" content="https://www.facebook.com/ichunyun">
  <meta property="article:author" content="https://www.facebook.com/ichunyun">
  <meta property="og:locale" content="en_US">





  
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Article",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "/blog/datafusion-performance/"
      },
      "headline": "datafusion 性能分析",
      "image": ,
      "datePublished": "2025-06-06",
      "dateModified": "",
      "author": {
        "@type": "Organization",
        "name": "datafusion 性能分析"
      },
      "publisher": {
        "@type": "Organization",
        "name": "datafusion 性能分析",
        
        "logo": {
          "@type": "ImageObject",
          "url": "/logo-doks.png"
        }
        
      },
      "description": "datafusion 性能分析"
    }
    </script>
  





<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BreadcrumbList",
    
      
      
        
        
        
        
        
        
        
        
          {
            "@type": "ListItem",
            "position":  1 ,
            "name": "Home",
            "item": "https://wangzaixiang.github.io/"
          },
          
          
          {
            "@type": "ListItem",
            "position":  2 ,
            "name": "Blog",
            "item": "https://wangzaixiang.github.io/blog/"
          },
        
      
        
        
        
        
        
        
        
        
        
        
        
          
          
          {
            "@type": "ListItem",
            "position":  3 ,
            "name": "Datafusion Performance",
            "item": "https://wangzaixiang.github.io/blog/datafusion-performance/"
          },
        
      
    
  }
</script>







  <meta name="theme-color" content="#fff">
  <link rel="apple-touch-icon" sizes="180x180" href="https://wangzaixiang.github.io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://wangzaixiang.github.io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://wangzaixiang.github.io/favicon-16x16.png">
  


  

</head>

  

<body class="blog single">
  
  
<div class="header-bar fixed-top"></div>
<header class="navbar fixed-top navbar-expand-md navbar-light">
	<div class="container">
		<input class="menu-btn order-0" type="checkbox" id="menu-btn">
		<label class="menu-icon d-md-none" for="menu-btn"><span class="navicon"></span></label>
		<a class="navbar-brand order-1 order-md-0 me-auto" href="https://wangzaixiang.github.io">程序人生</a>
		<button id="mode" class="btn btn-link order-2 order-md-4" type="button" aria-label="Toggle mode">
			<span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
			<span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
		</button>
		<ul class="navbar-nav fork-me order-3 order-md-5">
			
				
					<li class="nav-item">
						<a class="nav-link" href="https://twitter.com/wangzaixiang"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg><span class="ms-2 visually-hidden">Twitter</span></a>
					</li>
				
					<li class="nav-item">
						<a class="nav-link" href="https://github.com/wangzaixiang/"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="ms-2 visually-hidden">GitHub</span></a>
					</li>
				
			
		</ul>
		<div class="collapse navbar-collapse order-4 order-md-1">
			<ul class="navbar-nav main-nav me-auto order-5 order-md-2">
				
					
				
				
				
					
						<li class="nav-item blog active">
							<a class="nav-link" href="https://wangzaixiang.github.io/blog/">Blog</a>
						</li>
					
						<li class="nav-item">
							<a class="nav-link" href="https://wangzaixiang.github.io/monthly/">Monthly</a>
						</li>
					
						<li class="nav-item">
							<a class="nav-link" href="https://wangzaixiang.github.io/thoughts/">Thoughts</a>
						</li>
					
				
			</ul>
			<div class="break order-6 d-md-none"></div>
			
				<form class="navbar-form flex-grow-1 order-7 order-md-3">
					<input id="userinput" class="form-control is-search" type="search" placeholder="Search docs..."
						aria-label="Search docs..." autocomplete="off">
					<div id="suggestions" class="shadow bg-white rounded"></div>
				</form>
			
		</div>
	</div>
</header>



  
<div class="wrap container" role="document">
  <div class="content">
    <div class="row justify-content-center">
      
  
  <nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation">
  	<div class="page-links">
  			<h3>On this page</h3>
  			<nav id="TableOfContents">
  					<ul>
  							
  							<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#datafusion-duckdb-benchmark">datafusion-duckdb-benchmark</a></li>
  							
  							
  							<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#clickbench-dan-xian-cheng-ce-shi">clickbench 单线程测试</a></li>
  							
  									<ul>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-23">query 23</a></li>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-24-select-from-hits-where-url-like-google-order-by-eventtime-limit-10">query 24: SELECT * FROM hits WHERE URL LIKE &#x27;%google%&#x27; ORDER BY EventTime LIMIT 10</a></li>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-30">query 30</a></li>
  											
  									</ul>
  							
  							
  							<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#tpch-benchmark">tpch benchmark</a></li>
  							
  									<ul>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-1-duckdb-datafusion-3-33s-4-971s-sf-10">Query 1:   duckdb : datafusion =  3.33s : 4.971s (SF=10)</a></li>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-7-duckdb-datafusion-1-987s-5-536s">Query 7: duckdb: datafusion = 1.987s : 5.536s</a></li>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-17-subquery-duckdb-2-152s-datafusion-7-091s">Query 17: subquery duckdb 2.152s : datafusion 7.091s</a></li>
  											
  											<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#query-18-duckdb-3-495s-vs-datafusion-9-567s">Query 18:  duckdb: 3.495s vs datafusion: 9.567s</a></li>
  											
  									</ul>
  							
  							
  							<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#jie-lun-datafusion-xing-neng-de-zhu-yao-yin-su">结论： datafusion 性能的主要因素</a></li>
  							
  							
  							<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/#datafusion-wen-zhang-xi-lie">datafusion 文章系列</a></li>
  							
  							
  					</ul>
  			</nav>
  	</div>
  </nav>
  

      <div class="col-md-12 col-lg-10 col-xxl-12">



        <article>
          <div class="blog-header">
            <h1>datafusion 性能分析</h1>
            <nav style="display: flex; justify-content: space-between">
              
              <a href="https://wangzaixiang.github.io/blog/analysis-sql-extensions/"> ⇦ Previous </a>
              

              
<p><small>Posted June  6, 2025&nbsp;&hyphen;&nbsp;<strong>19&nbsp;min read</strong></small></p>


              
              <a href="https://wangzaixiang.github.io/blog/datafusion-window-function/"> Next ⇨ </a>
              
            </nav>

          </div>
          
          <p>本文记录我对 datafusion 的一些性能测试的数据、分析和思考。</p>
<p>从2023年起，我开始关注在公司的 BI 分析引擎中，引入 OLAP 引擎的底层计算能力，当时就开始评估了几个计算引擎，包括：</p>
<ul>
<li><a href="https://pola.rs">polars</a></li>
<li><a href="https://datafusion.apache.org">datafusion</a></li>
<li><a href="https://duckdb.org">duckdb</a></li>
</ul>
<p>关注的重点主要是 计算能力 和 计算性能，后面选择了 duckdb 作为我们的计算引擎，主要的优势：</p>
<ul>
<li>性能：duckdb 在大部份测试场景都具有领先或相当的性能（可参考我当时的一个测试：<a href="/inside-duckdb/preface.html">duckdb 测评</a>）</li>
<li>表达能力：duckdb 对窗口函数的支持程度基本上是最完备的（而我测试的其他包括 mysql, clickhouse, datafusion 都有不同程度的支持不充分），pola.rs
的窗口计算逻辑完全不同于 SQL 定义的窗口函数（而且我无法理解起底层逻辑是什么）。当然，我们后续在使用 duckdb 时，也发现了 duckdb 提供了很多有价值的
SQL 扩展，例如 group by grouping set 对分组小计等统计场景非常有帮助。</li>
<li>工具完善度：duckdb 的 工具，包括 CLI、python API 都设计得非常友好。</li>
</ul>
<p>25年，在阅读了<a href="https://docs.google.com/presentation/d/1gqcxSNLGVwaqN0_yJtCbNm19-w5pqPuktII5_EDA6_k">2024 Practice: Apache Arrow DataFusion A Fast, Embeddable, Modular Analytic Query Engine</a>
一文后，尤其是文中提到的性能对比后，我也在本地重跑了一次 datafusion-duckdb-benchmark 的对比，再花了些时间阅读了一下 datafusion 的源代码，
有了一些不同的认知：</p>
<ul>
<li>Rust 源代码的可读性相比 C++ 有了更好的提升（可能因为我喜欢 Rust 超过 C++），我也把阅读 hash-join, window function等算子整理了文章，在这个系列中进行了发表。</li>
<li>datafusion 的性能虽然整体上仍然不如 duckdb，但这个差距主要是工程上的成熟度，而非架构上的差异。</li>
</ul>
<p>本文主要针对 datafusion-duckdb-benchmark 这个项目的测试结果，对二者的差异进行分析，并尝试给出改进、优化 datafusion 的一些建议。
更新的 <a href="https://github.com/wangzaixiang/datafusion-duckdb-benchmark">datafusion-duckdb-benchmark</a> 项目:</p>
<ol>
<li>升级到最新的版本 datafusion 47.0.0 和 duckdb 1.3.0</li>
<li>配合本文对部份脚本进行了更新。</li>
</ol>
<h1 id="datafusion-duckdb-benchmark">datafusion-duckdb-benchmark</h1>
<ol>
<li>clickbench</li>
<li>tpch</li>
<li>h2o</li>
</ol>
<h1 id="clickbench-dan-xian-cheng-ce-shi">clickbench 单线程测试</h1>
<p><img src="https://wangzaixiang.github.io/blog/datafusion-performance/comparison.clickbench.png" alt="comparison.clickbench.png" /></p>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#65737e;">-- duckdb sql
</span><span> </span><span style="color:#b48ead;">with 
</span><span>   cb_datafusion as (</span><span style="color:#b48ead;">from</span><span>  read_csv(&#39;</span><span style="color:#a3be8c;">results/2025-06-17-df-48.0.0-duckdb-1.3.0-m1max/clickbench_datafusion.csv</span><span>&#39;, header=</span><span style="color:#d08770;">false</span><span>, columns= { &#39;</span><span style="color:#a3be8c;">query</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">core</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">seq</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">tm</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">double</span><span>&#39; } )),
</span><span>   cb_duckdb as (</span><span style="color:#b48ead;">from</span><span>  read_csv(&#39;</span><span style="color:#a3be8c;">results/2025-06-17-df-48.0.0-duckdb-1.3.0-m1max/clickbench_duckdb.csv</span><span>&#39;, header=</span><span style="color:#d08770;">false</span><span>, columns= { &#39;</span><span style="color:#a3be8c;">query</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">core</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">seq</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">int</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">tm</span><span>&#39;: &#39;</span><span style="color:#a3be8c;">double</span><span>&#39; } )),
</span><span>   duckdb as (</span><span style="color:#b48ead;">select</span><span> query, </span><span style="color:#96b5b4;">min</span><span>(tm) as tm </span><span style="color:#b48ead;">from</span><span> cb_duckdb </span><span style="color:#b48ead;">group by</span><span> query </span><span style="color:#b48ead;">order by</span><span> query), 
</span><span>   datafusion as (</span><span style="color:#b48ead;">select</span><span> query, </span><span style="color:#96b5b4;">min</span><span>(tm) as tm </span><span style="color:#b48ead;">from</span><span> cb_datafusion </span><span style="color:#b48ead;">group by</span><span> query </span><span style="color:#b48ead;">order by</span><span> query)
</span><span>  </span><span style="color:#b48ead;">select </span><span style="color:#d08770;">duckdb</span><span>.</span><span style="color:#d08770;">query</span><span>, round(</span><span style="color:#d08770;">duckdb</span><span>.</span><span style="color:#d08770;">tm</span><span>,</span><span style="color:#d08770;">3</span><span>) as &quot;</span><span style="color:#a3be8c;">duckdb time</span><span>&quot;, round(</span><span style="color:#d08770;">datafusion</span><span>.</span><span style="color:#d08770;">tm</span><span>,</span><span style="color:#d08770;">3</span><span>) as &quot;</span><span style="color:#a3be8c;">datafusion time</span><span>&quot;, round((</span><span style="color:#d08770;">datafusion</span><span>.</span><span style="color:#d08770;">tm </span><span>- </span><span style="color:#d08770;">duckdb</span><span>.</span><span style="color:#d08770;">tm</span><span>) / (</span><span style="color:#d08770;">duckdb</span><span>.</span><span style="color:#d08770;">tm</span><span>) </span><span style="color:#bf616a;">* </span><span style="color:#d08770;">100</span><span>, </span><span style="color:#d08770;">2</span><span>) as &quot;</span><span style="color:#a3be8c;">diff%</span><span>&quot; 
</span><span>  </span><span style="color:#b48ead;">from</span><span> duckdb </span><span style="color:#b48ead;">left join</span><span> datafusion on </span><span style="color:#d08770;">duckdb</span><span>.</span><span style="color:#d08770;">query </span><span>= </span><span style="color:#d08770;">datafusion</span><span>.</span><span style="color:#d08770;">query
</span><span>  </span><span style="color:#b48ead;">order by </span><span style="color:#d08770;">1</span><span>;
</span></code></pre>
<table><thead><tr><th style="text-align: right">query</th><th style="text-align: right">duckdb time</th><th style="text-align: right">datafusion time</th><th style="text-align: right">diff%</th></tr></thead><tbody>
<tr><td style="text-align: right">1</td><td style="text-align: right">0.03</td><td style="text-align: right">0.033</td><td style="text-align: right">12.23</td></tr>
<tr><td style="text-align: right">2</td><td style="text-align: right">0.109</td><td style="text-align: right">0.071</td><td style="text-align: right">-35.08</td></tr>
<tr><td style="text-align: right">3</td><td style="text-align: right">0.285</td><td style="text-align: right">0.321</td><td style="text-align: right">12.51</td></tr>
<tr><td style="text-align: right">4</td><td style="text-align: right">0.394</td><td style="text-align: right">0.287</td><td style="text-align: right">-27.19</td></tr>
<tr><td style="text-align: right">5</td><td style="text-align: right">2.411</td><td style="text-align: right">2.219</td><td style="text-align: right">-7.96</td></tr>
<tr><td style="text-align: right">6</td><td style="text-align: right">2.931</td><td style="text-align: right">3.111</td><td style="text-align: right">6.15</td></tr>
<tr><td style="text-align: right">7</td><td style="text-align: right">1.633</td><td style="text-align: right">0.063</td><td style="text-align: right">-96.15</td></tr>
<tr><td style="text-align: right">8</td><td style="text-align: right">0.117</td><td style="text-align: right">0.075</td><td style="text-align: right">-36.21</td></tr>
<tr><td style="text-align: right">9</td><td style="text-align: right">2.95</td><td style="text-align: right">2.629</td><td style="text-align: right">-10.87</td></tr>
<tr><td style="text-align: right">10</td><td style="text-align: right">4.04</td><td style="text-align: right">3.929</td><td style="text-align: right">-2.75</td></tr>
<tr><td style="text-align: right">11</td><td style="text-align: right">0.651</td><td style="text-align: right">1.008</td><td style="text-align: right">55.0</td></tr>
<tr><td style="text-align: right">12</td><td style="text-align: right">0.757</td><td style="text-align: right">1.133</td><td style="text-align: right">49.66</td></tr>
<tr><td style="text-align: right">13</td><td style="text-align: right">2.781</td><td style="text-align: right">2.917</td><td style="text-align: right">4.91</td></tr>
<tr><td style="text-align: right">14</td><td style="text-align: right">4.062</td><td style="text-align: right">3.907</td><td style="text-align: right">-3.81</td></tr>
<tr><td style="text-align: right">15</td><td style="text-align: right">2.968</td><td style="text-align: right">2.763</td><td style="text-align: right">-6.92</td></tr>
<tr><td style="text-align: right">16</td><td style="text-align: right">2.673</td><td style="text-align: right">2.596</td><td style="text-align: right">-2.86</td></tr>
<tr><td style="text-align: right">17</td><td style="text-align: right">5.652</td><td style="text-align: right">5.042</td><td style="text-align: right">-10.79</td></tr>
<tr><td style="text-align: right">18</td><td style="text-align: right">5.57</td><td style="text-align: right">5.024</td><td style="text-align: right">-9.8</td></tr>
<tr><td style="text-align: right">19</td><td style="text-align: right">10.476</td><td style="text-align: right">8.318</td><td style="text-align: right">-20.6</td></tr>
<tr><td style="text-align: right">20</td><td style="text-align: right">0.095</td><td style="text-align: right">0.241</td><td style="text-align: right">151.94</td></tr>
<tr><td style="text-align: right">21</td><td style="text-align: right">7.064</td><td style="text-align: right">6.455</td><td style="text-align: right">-8.62</td></tr>
<tr><td style="text-align: right">22</td><td style="text-align: right">5.578</td><td style="text-align: right">7.659</td><td style="text-align: right">37.31</td></tr>
<tr><td style="text-align: right">23</td><td style="text-align: right">10.85</td><td style="text-align: right">14.823</td><td style="text-align: right">36.62</td></tr>
<tr><td style="text-align: right">24</td><td style="text-align: right">7.969</td><td style="text-align: right">39.1</td><td style="text-align: right">390.67</td></tr>
<tr><td style="text-align: right">25</td><td style="text-align: right">2.454</td><td style="text-align: right">2.314</td><td style="text-align: right">-5.69</td></tr>
<tr><td style="text-align: right">26</td><td style="text-align: right">1.708</td><td style="text-align: right">2.048</td><td style="text-align: right">19.93</td></tr>
<tr><td style="text-align: right">27</td><td style="text-align: right">2.251</td><td style="text-align: right">2.613</td><td style="text-align: right">16.09</td></tr>
<tr><td style="text-align: right">28</td><td style="text-align: right">5.094</td><td style="text-align: right">10.745</td><td style="text-align: right">110.92</td></tr>
<tr><td style="text-align: right">29</td><td style="text-align: right">29.147</td><td style="text-align: right">28.087</td><td style="text-align: right">-3.64</td></tr>
<tr><td style="text-align: right">30</td><td style="text-align: right">0.24</td><td style="text-align: right">2.405</td><td style="text-align: right">904.0</td></tr>
<tr><td style="text-align: right">31</td><td style="text-align: right">3.086</td><td style="text-align: right">2.896</td><td style="text-align: right">-6.15</td></tr>
<tr><td style="text-align: right">32</td><td style="text-align: right">3.544</td><td style="text-align: right">2.911</td><td style="text-align: right">-17.86</td></tr>
<tr><td style="text-align: right">33</td><td style="text-align: right">10.346</td><td style="text-align: right">8.892</td><td style="text-align: right">-14.05</td></tr>
<tr><td style="text-align: right">34</td><td style="text-align: right">9.928</td><td style="text-align: right">11.879</td><td style="text-align: right">19.65</td></tr>
<tr><td style="text-align: right">35</td><td style="text-align: right">10.395</td><td style="text-align: right">11.869</td><td style="text-align: right">14.19</td></tr>
<tr><td style="text-align: right">36</td><td style="text-align: right">2.916</td><td style="text-align: right">3.819</td><td style="text-align: right">30.97</td></tr>
<tr><td style="text-align: right">37</td><td style="text-align: right">0.125</td><td style="text-align: right">0.152</td><td style="text-align: right">22.28</td></tr>
<tr><td style="text-align: right">38</td><td style="text-align: right">0.101</td><td style="text-align: right">0.093</td><td style="text-align: right">-7.43</td></tr>
<tr><td style="text-align: right">39</td><td style="text-align: right">0.066</td><td style="text-align: right">0.112</td><td style="text-align: right">69.53</td></tr>
<tr><td style="text-align: right">40</td><td style="text-align: right">0.222</td><td style="text-align: right">0.292</td><td style="text-align: right">31.95</td></tr>
<tr><td style="text-align: right">41</td><td style="text-align: right">0.052</td><td style="text-align: right">0.033</td><td style="text-align: right">-36.48</td></tr>
<tr><td style="text-align: right">42</td><td style="text-align: right">0.047</td><td style="text-align: right">0.031</td><td style="text-align: right">-33.35</td></tr>
<tr><td style="text-align: right">43</td><td style="text-align: right">0.062</td><td style="text-align: right">0.039</td><td style="text-align: right">-36.65</td></tr>
</tbody></table>
<p>在43个场景中，有23个场景 datafusion 更快，有20个场景，datafusion 更慢, 其中差异比较显著的是：</p>
<table><thead><tr><th style="text-align: right">query</th><th style="text-align: right">duckdb time</th><th style="text-align: right">datafusion time</th><th style="text-align: right">diff%</th><th>analyze</th></tr></thead><tbody>
<tr><td style="text-align: right">1</td><td style="text-align: right">0.03</td><td style="text-align: right">0.033</td><td style="text-align: right">12.23</td><td></td></tr>
<tr><td style="text-align: right">3</td><td style="text-align: right">0.285</td><td style="text-align: right">0.321</td><td style="text-align: right">12.51</td><td></td></tr>
<tr><td style="text-align: right">6</td><td style="text-align: right">2.931</td><td style="text-align: right">3.111</td><td style="text-align: right">6.15</td><td></td></tr>
<tr><td style="text-align: right">11</td><td style="text-align: right">0.651</td><td style="text-align: right">1.008</td><td style="text-align: right">55.0</td><td></td></tr>
<tr><td style="text-align: right">12</td><td style="text-align: right">0.757</td><td style="text-align: right">1.133</td><td style="text-align: right">49.66</td><td></td></tr>
<tr><td style="text-align: right">13</td><td style="text-align: right">2.781</td><td style="text-align: right">2.917</td><td style="text-align: right">4.91</td><td></td></tr>
<tr><td style="text-align: right">20</td><td style="text-align: right">0.095</td><td style="text-align: right">0.241</td><td style="text-align: right">151.94</td><td>TODO</td></tr>
<tr><td style="text-align: right">22</td><td style="text-align: right">5.578</td><td style="text-align: right">7.659</td><td style="text-align: right">37.31</td><td></td></tr>
<tr><td style="text-align: right">23</td><td style="text-align: right">10.85</td><td style="text-align: right">14.823</td><td style="text-align: right">36.62</td><td>TODO</td></tr>
<tr><td style="text-align: right">24</td><td style="text-align: right">7.969</td><td style="text-align: right">39.1</td><td style="text-align: right">390.67</td><td>duckdb 生成了更好的 TOP-N 执行计划</td></tr>
<tr><td style="text-align: right">26</td><td style="text-align: right">1.708</td><td style="text-align: right">2.048</td><td style="text-align: right">19.93</td><td></td></tr>
<tr><td style="text-align: right">27</td><td style="text-align: right">2.251</td><td style="text-align: right">2.613</td><td style="text-align: right">16.09</td><td></td></tr>
<tr><td style="text-align: right">28</td><td style="text-align: right">5.094</td><td style="text-align: right">10.745</td><td style="text-align: right">110.92</td><td>TODO</td></tr>
<tr><td style="text-align: right">30</td><td style="text-align: right">0.24</td><td style="text-align: right">2.405</td><td style="text-align: right">904.0</td><td>duckdb 有更好的公共表达式优化</td></tr>
<tr><td style="text-align: right">34</td><td style="text-align: right">9.928</td><td style="text-align: right">11.879</td><td style="text-align: right">19.65</td><td></td></tr>
<tr><td style="text-align: right">35</td><td style="text-align: right">10.395</td><td style="text-align: right">11.869</td><td style="text-align: right">14.19</td><td></td></tr>
<tr><td style="text-align: right">36</td><td style="text-align: right">2.916</td><td style="text-align: right">3.819</td><td style="text-align: right">30.97</td><td></td></tr>
<tr><td style="text-align: right">37</td><td style="text-align: right">0.125</td><td style="text-align: right">0.152</td><td style="text-align: right">22.28</td><td></td></tr>
<tr><td style="text-align: right">39</td><td style="text-align: right">0.066</td><td style="text-align: right">0.112</td><td style="text-align: right">69.53</td><td></td></tr>
<tr><td style="text-align: right">40</td><td style="text-align: right">0.222</td><td style="text-align: right">0.292</td><td style="text-align: right">31.95</td><td></td></tr>
</tbody></table>
<h2 id="query-23">query 23</h2>
<ul>
<li>duckdb: TABLE_SCAN 11.49s, output: 7128 rows (98%)</li>
<li>datafusion:</li>
</ul>
<h2 id="query-24-select-from-hits-where-url-like-google-order-by-eventtime-limit-10">query 24: <code>SELECT * FROM hits WHERE URL LIKE '%google%' ORDER BY EventTime LIMIT 10</code></h2>
<p>duckdb 生成了更好的查询计划：</p>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span> </span><span style="color:#b48ead;">select</span><span> a.</span><span style="color:#bf616a;">* 
</span><span> </span><span style="color:#b48ead;">from</span><span> hits a 
</span><span> </span><span style="color:#b48ead;">join
</span><span>     (</span><span style="color:#b48ead;">select</span><span> file_index, file_row_number </span><span style="color:#b48ead;">from</span><span> hits </span><span style="color:#b48ead;">where</span><span> URL LIKE &#39;</span><span style="color:#a3be8c;">%google%</span><span>&#39; </span><span style="color:#b48ead;">ORDER BY</span><span> EventTime </span><span style="color:#b48ead;">LIMIT </span><span style="color:#d08770;">10</span><span>) b 
</span><span> on </span><span style="color:#d08770;">a</span><span>.</span><span style="color:#d08770;">file_index </span><span>= </span><span style="color:#d08770;">b</span><span>.</span><span style="color:#d08770;">file_index </span><span>and </span><span style="color:#d08770;">a</span><span>.</span><span style="color:#d08770;">file_row_number </span><span>= </span><span style="color:#d08770;">b</span><span>.</span><span style="color:#d08770;">file_row_number
</span></code></pre>
<p>这个优化，极大的减少了 parquet 的扫描开销。</p>
<h2 id="query-30">query 30</h2>
<p>duckdb 对公共表达式优化进行了更好的优化，将 <code>SUM(col + n)</code> 替换为 <code>SUM(col) + n * COUNT(col)</code>, 这样对 Query 30 中多达 90 个 <code>SUM(col + n)</code>
的字段，最后优化到只有2个分组计算： <code>SUM(col)</code> 和 <code>COUNT(col)</code>。
优化： 参考 duckdb 的表达式优化策略。</p>
<h1 id="tpch-benchmark">tpch benchmark</h1>
<p><img src="https://wangzaixiang.github.io/blog/datafusion-performance/comparison.tpch.png" alt="comparison.tpch.png" />
这个测试在 M1-MAX 64G 上运行。</p>
<table><thead><tr><th style="text-align: right">query</th><th style="text-align: right">duckdb time</th><th style="text-align: right">datafusion time</th><th style="text-align: right">diff%</th></tr></thead><tbody>
<tr><td style="text-align: right">1</td><td style="text-align: right">2.624</td><td style="text-align: right">4.939</td><td style="text-align: right">88.23</td></tr>
<tr><td style="text-align: right">2</td><td style="text-align: right">0.37</td><td style="text-align: right">0.84</td><td style="text-align: right">126.78</td></tr>
<tr><td style="text-align: right">3</td><td style="text-align: right">1.584</td><td style="text-align: right">1.634</td><td style="text-align: right">3.17</td></tr>
<tr><td style="text-align: right">4</td><td style="text-align: right">1.117</td><td style="text-align: right">0.897</td><td style="text-align: right">-19.63</td></tr>
<tr><td style="text-align: right">5</td><td style="text-align: right">1.753</td><td style="text-align: right">2.412</td><td style="text-align: right">37.64</td></tr>
<tr><td style="text-align: right">6</td><td style="text-align: right">0.742</td><td style="text-align: right">0.822</td><td style="text-align: right">10.74</td></tr>
<tr><td style="text-align: right">7</td><td style="text-align: right">1.659</td><td style="text-align: right">4.817</td><td style="text-align: right">190.37</td></tr>
<tr><td style="text-align: right">8</td><td style="text-align: right">2.413</td><td style="text-align: right">2.835</td><td style="text-align: right">17.47</td></tr>
<tr><td style="text-align: right">9</td><td style="text-align: right">3.651</td><td style="text-align: right">4.605</td><td style="text-align: right">26.11</td></tr>
<tr><td style="text-align: right">10</td><td style="text-align: right">2.503</td><td style="text-align: right">2.587</td><td style="text-align: right">3.35</td></tr>
<tr><td style="text-align: right">11</td><td style="text-align: right">0.347</td><td style="text-align: right">0.949</td><td style="text-align: right">173.3</td></tr>
<tr><td style="text-align: right">12</td><td style="text-align: right">0.918</td><td style="text-align: right">1.556</td><td style="text-align: right">69.45</td></tr>
<tr><td style="text-align: right">13</td><td style="text-align: right">2.859</td><td style="text-align: right">2.503</td><td style="text-align: right">-12.44</td></tr>
<tr><td style="text-align: right">14</td><td style="text-align: right">1.03</td><td style="text-align: right">1.194</td><td style="text-align: right">15.95</td></tr>
<tr><td style="text-align: right">15</td><td style="text-align: right">0.907</td><td style="text-align: right">2.331</td><td style="text-align: right">156.89</td></tr>
<tr><td style="text-align: right">16</td><td style="text-align: right">0.337</td><td style="text-align: right">0.524</td><td style="text-align: right">55.21</td></tr>
<tr><td style="text-align: right">17</td><td style="text-align: right">1.679</td><td style="text-align: right">5.537</td><td style="text-align: right">229.75</td></tr>
<tr><td style="text-align: right">18</td><td style="text-align: right">2.779</td><td style="text-align: right">8.695</td><td style="text-align: right">212.84</td></tr>
<tr><td style="text-align: right">19</td><td style="text-align: right">1.5</td><td style="text-align: right">2.584</td><td style="text-align: right">72.31</td></tr>
<tr><td style="text-align: right">20</td><td style="text-align: right">1.347</td><td style="text-align: right">2.007</td><td style="text-align: right">49.0</td></tr>
<tr><td style="text-align: right">21</td><td style="text-align: right">4.58</td><td style="text-align: right">7.678</td><td style="text-align: right">67.63</td></tr>
<tr><td style="text-align: right">22</td><td style="text-align: right">0.498</td><td style="text-align: right">0.765</td><td style="text-align: right">53.83</td></tr>
</tbody></table>
<p>在 TPCH 的测试中，datafusion 整体落后于 duckdb，除 4/13 要更快一些之外，其余的 20 个查询都更慢，差距比较大的是 2/7/11/15/17/18 号查询。</p>
<h2 id="query-1-duckdb-datafusion-3-33s-4-971s-sf-10">Query 1:   duckdb : datafusion =  3.33s : 4.971s (SF=10)</h2>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span> </span><span style="color:#b48ead;">select</span><span>	l_returnflag,	l_linestatus,
</span><span>          </span><span style="color:#96b5b4;">sum</span><span>(l_quantity) as sum_qty,
</span><span>          </span><span style="color:#96b5b4;">sum</span><span>(l_extendedprice) as sum_base_price,
</span><span>          </span><span style="color:#96b5b4;">sum</span><span>(l_extendedprice </span><span style="color:#bf616a;">*</span><span> (</span><span style="color:#d08770;">1 </span><span>- l_discount)) as sum_disc_price,
</span><span>          </span><span style="color:#96b5b4;">sum</span><span>(l_extendedprice </span><span style="color:#bf616a;">*</span><span> (</span><span style="color:#d08770;">1 </span><span>- l_discount) </span><span style="color:#bf616a;">*</span><span> (</span><span style="color:#d08770;">1 </span><span>+ l_tax)) as sum_charge,
</span><span>          </span><span style="color:#96b5b4;">avg</span><span>(l_quantity) as avg_qty,
</span><span>          </span><span style="color:#96b5b4;">avg</span><span>(l_extendedprice) as avg_price,
</span><span>          </span><span style="color:#96b5b4;">avg</span><span>(l_discount) as avg_disc,
</span><span>          </span><span style="color:#96b5b4;">count</span><span>(</span><span style="color:#bf616a;">*</span><span>) as count_order
</span><span> </span><span style="color:#b48ead;">from</span><span>	lineitem
</span><span> </span><span style="color:#b48ead;">where</span><span>	l_shipdate &lt;= </span><span style="color:#b48ead;">date </span><span>&#39;</span><span style="color:#a3be8c;">1998-09-02</span><span>&#39;
</span><span> </span><span style="color:#b48ead;">group by</span><span>	l_returnflag,	l_linestatus
</span><span> </span><span style="color:#b48ead;">order by</span><span>	l_returnflag,	l_linestatus 
</span></code></pre>
<ul>
<li>datafusion
<ul>
<li>算子耗时：使用 <code>explain analyze</code>
<ul>
<li>DataSourceExec output_rows: 59,986,052 time_elapsed_processing: 1.029s</li>
<li>FilterExec     output_rows: 59,142,609 elapsed_compute: 173.698ms</li>
<li>CoalesceBatchesExec:  output_rows: 59,142,609 elapsed_compute: 624.365ms <em>DuckDB 没有这个开销</em></li>
<li>ProjectionExec: elapsed_compute: 448.843035ms</li>
<li>AggregateExec:  output_rows: 4, elapsed_compute: 2.581794006s</li>
</ul>
</li>
<li><a href="https://share.firefox.dev/4lrfgTI">samply profile</a></li>
</ul>
</li>
<li>duckdb 3.33s
<ul>
<li>算子耗时
<ul>
<li>TableScan:   output_rows: 59142609, time: 1.20s</li>
<li>Projection:  0.12s + 0.11s</li>
<li>HASH_GROUP_BY:  1.85s</li>
</ul>
</li>
<li><a href="https://share.firefox.dev/4l0qZsr">samply profile</a></li>
</ul>
</li>
<li>对比
<ul>
<li>DataFusion 的 CoalesceBatchExec 开销 0.624s，在 DuckDB 没有这一步处理。
<ul>
<li>使用 <code>set datafusion.execution.coalesce_batches = false</code> 执行时，其效果与 duckdb 相似，减少了这个算子的开销</li>
</ul>
</li>
<li>ProjectionExec, DataFusion多耗时 0.218s
<ul>
<li>datafusion 只计算了 <code>l_extendedprice * (1 - l_discount)</code> 耗时 475ms</li>
<li>duckdb 有两个计算：
<ul>
<li><code>a: l_extendedprice * (1 - l_discount)</code> 耗时 120ms</li>
<li><code>a * (1.00 + l_tax)</code> 耗时 0.11s</li>
</ul>
</li>
<li>对比而言，datafusion 在表达式求值的执行效率上，要比 duckdb 慢了很多。</li>
</ul>
</li>
<li>AggregateExec:  DataFusion 多耗时：0.732s
<ul>
<li>datafusion 需要在这个阶段进行更多的表达式计算，且执行效率只有 duckdb 的 25%</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="query-7-duckdb-datafusion-1-987s-5-536s">Query 7: duckdb: datafusion = 1.987s : 5.536s</h2>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">select</span><span>	supp_nation,	cust_nation,	l_year,	</span><span style="color:#96b5b4;">sum</span><span>(volume) as revenue	
</span><span style="color:#b48ead;">from</span><span>	(	
</span><span>   </span><span style="color:#b48ead;">select	</span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_name </span><span>as supp_nation,	</span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_name </span><span>as cust_nation,	extract(year </span><span style="color:#b48ead;">from</span><span> l_shipdate) as l_year,	l_extendedprice </span><span style="color:#bf616a;">*</span><span> (</span><span style="color:#d08770;">1 </span><span>- l_discount) as volume	
</span><span>   </span><span style="color:#b48ead;">from</span><span>	supplier,	lineitem,	orders,	customer,	nation n1,	nation n2	
</span><span>   </span><span style="color:#b48ead;">where</span><span>	s_suppkey = l_suppkey	and o_orderkey = l_orderkey	and c_custkey = o_custkey	and s_nationkey = </span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_nationkey
</span><span>     and c_nationkey = </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_nationkey	
</span><span>     and (	(</span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_name </span><span>= &#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39; and </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_name </span><span>= &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39;)	or (</span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_name </span><span>= &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39; and </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_name </span><span>= &#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39;)	)	
</span><span>     and l_shipdate between </span><span style="color:#b48ead;">date </span><span>&#39;</span><span style="color:#a3be8c;">1995-01-01</span><span>&#39; and </span><span style="color:#b48ead;">date </span><span>&#39;</span><span style="color:#a3be8c;">1996-12-31</span><span>&#39;	
</span><span>) as shipping	
</span><span style="color:#b48ead;">group by</span><span>	supp_nation,	cust_nation,	l_year	
</span><span style="color:#b48ead;">order by</span><span>	supp_nation,	cust_nation,	l_year;
</span></code></pre>
<ul>
<li>
<p>relation graph
<div class="mermaid">
    ```mermaid
     flowchart TD
       lineitem[lineitem 60m filtered 18.2m] --- orders[orders 15m] --- customer[customer 1.5m] --- nation_2[nation2 25 filtered 2]
       lineitem --- supplier[supplier 100K] --- nation_1[nation1 25 filtered 2]
     ```
</div></p>
</li>
<li>
<p>datafusion</p>
<ul>
<li>Join Order:
<div class="mermaid">
    ```mermaid
         flowchart TD
           lineitem[lineitem 60m filtered 18.2m] ---|2| orders[orders 15m] ---|3| customer[customer 1.5m] ---|4| nation_2[nation2 25 filtered 2]
           lineitem ---|1| supplier[supplier 100K] ---|5| nation_1[nation1 25 filtered 2]
       ```
</div>
<div class="mermaid">
    ```mermaid
       flowchart TD
        S[supplier\n100K] --&gt;|build| j1[Join\n18.2m]
        L[lineitem\n60m] --&gt; f1[Filter\n18.2m] --&gt;|input| j1 --&gt;|build| j2[Join\n18.2m]
        O[orders\n15m] --&gt;|input| j2 --&gt;|build| j3[Join \n18.2m]
        C[customer\n1.5m] --&gt;|input| j3 --&gt;|build| j4[Join \n1.5m]
        N1[nation] --&gt; f2[Filter\n2] --&gt;|input| j4 --&gt;|build| j5[Join\n58k]
        N2[nation] --&gt; f3[Filter\n2] --&gt;|input| j5 
       ```
</div>
参考这个图：基本上，datafusion 选择了几乎最差的 join-path。</li>
<li>DataSourceExec: lineitem, output_rows: 59,986,052, time_elapsed_processing: 1.21s</li>
<li>FilterExec lineitem, output_rows: 18,230,325, elapsed_compute: 151.385ms</li>
<li>CoalesceBatchExec: lineitem, elapsed_compute:28.304ms</li>
<li>DataSourceExec: Supplier, output rows: 100,000, time_elapsed_processing: 1.103ms</li>
<li>JoinExec (lineitem * Supplier), output rows: 18,230,325  build_time: 1.902ms   join_time: 217.514ms</li>
<li>CoalesceBatchExec( lineitem * supplier),  output rows: 18,230,325, elapsed_compute: 65.489ms</li>
<li>DataSourceExec(orders): output_rows: 15,000,000   time_elapsed_processing: 203.315ms</li>
<li>JoinExec( lineitem * Supplier * orders ): output_rows: 18230325, build_time: 2.245s, join_time: 554.960ms</li>
<li>JoinExec( lineitem * supplier * orders * customers: 1,500,000): output_rows: 18,230,325, build_time: 3.510002485s, join_time: 1.391s</li>
<li>JoinExec( lineitem * supplier * orders * customers * nation: 2): output_rows:  1,460,257    build time: 5.060385334s, join_time: 66.956ms</li>
<li>JoinExec( lineitem * supplier * orders * customers * nation * nation): output_rows: 58365,  build time: 5.147108365s  join_time; 5.428ms</li>
<li><input disabled="" type="checkbox"/>
datafusion 的 explain analyze 对 JOIN 的 耗时计算并不准确，其时间包括了上游数据的处理时间。实际 build time 没有这么大。</li>
<li><a href="https://share.firefox.dev/44D0Aes">Samply Profile</a></li>
</ul>
</li>
<li>
<p>duckdb</p>
<ul>
<li>
<p>Join Order
<code>(orders X (lineitem X (supplier X nation))) * (customer X nation)</code>
<div class="mermaid">
    ```mermaid
       flowchart TD
       lineitem[lineitem 60m filtered 18.2m] ---|3| orders[orders 15m] ---|5| customer[customer 1.5m] ---|4| nation_2[nation2 25 filtered 2]
       lineitem ---|2| supplier[supplier 100K] ---|1| nation_1[nation1 25 filtered 2]
       ```
</div></p>
</li>
<li>
<p>duckdb 对 JOIN 有 right filter left 的 优化，可以大大的减少 probe side 的扫描成本</p>
</li>
<li>
<p>作为对比： duckdb 的 JOIN 耗时总共为 430ms。</p>
<ul>
<li><a href="https://share.firefox.dev/4nnkj9q">Samply Profile</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p>对比</p>
<ul>
<li>对这个查询，duckdb 处理的关联顺序基本上是错误的，最佳的关联顺序应该是 <code>(filter(lineitem) X supplier X orders X customer X nation X nation </code></li>
<li><input disabled="" type="checkbox"/>
尝试手动编写物理查询计划，来做一个性能对比</li>
<li>Coalesce带来了额外的开销。</li>
<li>使用 CTE 方式改写上面的 SQL<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span> </span><span style="color:#b48ead;">with</span><span> j1 as (
</span><span>     </span><span style="color:#b48ead;">select </span><span style="color:#d08770;">s</span><span>.</span><span style="color:#d08770;">s_suppkey</span><span>, </span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_name </span><span>as supp_nation </span><span style="color:#b48ead;">from</span><span> supplier s </span><span style="color:#b48ead;">join</span><span> nation n1 on </span><span style="color:#d08770;">s</span><span>.</span><span style="color:#d08770;">s_nationkey </span><span>= </span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_nationkey
</span><span>     </span><span style="color:#b48ead;">where </span><span style="color:#d08770;">n1</span><span>.</span><span style="color:#d08770;">n_name </span><span>in (&#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39;)
</span><span> ),
</span><span> j2 as (
</span><span>     </span><span style="color:#b48ead;">select </span><span style="color:#d08770;">c</span><span>.</span><span style="color:#d08770;">c_custkey</span><span>, </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_name </span><span>as cust_nation </span><span style="color:#b48ead;">from</span><span> customer c </span><span style="color:#b48ead;">join</span><span> nation n2 on </span><span style="color:#d08770;">c</span><span>.</span><span style="color:#d08770;">c_nationkey </span><span>= </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_nationkey
</span><span>     </span><span style="color:#b48ead;">where </span><span style="color:#d08770;">n2</span><span>.</span><span style="color:#d08770;">n_name </span><span>in (&#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39;)
</span><span> ),
</span><span> j3 as (
</span><span>     </span><span style="color:#b48ead;">select </span><span style="color:#d08770;">o</span><span>.</span><span style="color:#d08770;">o_orderkey</span><span>, </span><span style="color:#d08770;">j2</span><span>.</span><span style="color:#d08770;">cust_nation </span><span style="color:#b48ead;">from</span><span> orders o </span><span style="color:#b48ead;">join</span><span> j2 on </span><span style="color:#d08770;">o</span><span>.</span><span style="color:#d08770;">o_custkey </span><span>= </span><span style="color:#d08770;">j2</span><span>.</span><span style="color:#d08770;">c_custkey
</span><span> ),
</span><span> j4 as (
</span><span>     </span><span style="color:#b48ead;">select</span><span> extract(year </span><span style="color:#b48ead;">from</span><span> l_shipdate) as l_year,
</span><span>     l_extendedprice </span><span style="color:#bf616a;">*</span><span> (</span><span style="color:#d08770;">1 </span><span>- l_discount) as volume, </span><span style="color:#d08770;">j1</span><span>.</span><span style="color:#d08770;">supp_nation</span><span>, </span><span style="color:#d08770;">l</span><span>.</span><span style="color:#d08770;">l_orderkey
</span><span>     </span><span style="color:#b48ead;">from</span><span> lineitem l </span><span style="color:#b48ead;">join</span><span> j1 on </span><span style="color:#d08770;">l</span><span>.</span><span style="color:#d08770;">l_suppkey </span><span>= </span><span style="color:#d08770;">j1</span><span>.</span><span style="color:#d08770;">s_suppkey
</span><span>     </span><span style="color:#b48ead;">where</span><span> l_shipdate between </span><span style="color:#b48ead;">date </span><span>&#39;</span><span style="color:#a3be8c;">1995-01-01</span><span>&#39; and </span><span style="color:#b48ead;">date </span><span>&#39;</span><span style="color:#a3be8c;">1996-12-31</span><span>&#39;
</span><span> ),
</span><span> j5 as (
</span><span>     </span><span style="color:#b48ead;">select</span><span> l_year, volume, supp_nation, cust_nation
</span><span>     </span><span style="color:#b48ead;">from</span><span> j4 </span><span style="color:#b48ead;">join</span><span> j3 on l_orderkey = </span><span style="color:#d08770;">j3</span><span>.</span><span style="color:#d08770;">o_orderkey
</span><span> )
</span><span> </span><span style="color:#b48ead;">select</span><span>      supp_nation,    cust_nation,    l_year, </span><span style="color:#96b5b4;">sum</span><span>(volume) as revenue
</span><span> </span><span style="color:#b48ead;">from</span><span> j5
</span><span> </span><span style="color:#b48ead;">where</span><span> (supp_nation = &#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39; and cust_nation = &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39;) or (supp_nation = &#39;</span><span style="color:#a3be8c;">GERMANY</span><span>&#39; and cust_nation = &#39;</span><span style="color:#a3be8c;">FRANCE</span><span>&#39;)
</span><span> </span><span style="color:#b48ead;">group by</span><span>     supp_nation,    cust_nation,    l_year
</span><span> </span><span style="color:#b48ead;">order by</span><span>     supp_nation,    cust_nation,    l_year            
</span></code></pre>
这个 SQL 理论上是针对这个 case 的最佳执行计划，在 duckdb 中与原始版本几乎一致（1.98s 优化并不明显），datafusion 中执行时间提升到 2.90s(改写前：5.536s)
这也验证了 join 的顺序对性能的影响是显著的
<blockquote>
<p>为什么这个最优化的查询计划仍然不如 duckdb? 经过查看执行计划，datafusion 仍然没有正确的处理 build side 和 probe side, 选择了
数据量更大的一端作为 build side， 目前，datafusion 无法在 SQL 中使用 tips 进行调整。</p>
</blockquote>
</li>
</ul>
<p>这个案例是一个很好的学习 Join 优化的案例，我会结合这个案例来阅读论文 《Dynamic Programming Strikes Back》 以加深对这方面知识的理解。</p>
</li>
</ul>
<h2 id="query-17-subquery-duckdb-2-152s-datafusion-7-091s">Query 17: subquery duckdb 2.152s : datafusion 7.091s</h2>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">select	</span><span style="color:#96b5b4;">sum</span><span>(l_extendedprice) / </span><span style="color:#d08770;">7</span><span>.</span><span style="color:#d08770;">0 </span><span>as avg_yearly
</span><span style="color:#b48ead;">from</span><span>	lineitem,	part
</span><span style="color:#b48ead;">where</span><span>	p_partkey = l_partkey	and p_brand = &#39;</span><span style="color:#a3be8c;">Brand#23</span><span>&#39;	and p_container = &#39;</span><span style="color:#a3be8c;">MED BOX</span><span>&#39;
</span><span>  and l_quantity &lt; (	</span><span style="color:#b48ead;">select	</span><span style="color:#d08770;">0</span><span>.</span><span style="color:#d08770;">2 </span><span style="color:#bf616a;">* </span><span style="color:#96b5b4;">avg</span><span>(l_quantity)	</span><span style="color:#b48ead;">from</span><span>	lineitem	</span><span style="color:#b48ead;">where</span><span>	l_partkey = p_partkey ) 
</span></code></pre>
<ul>
<li>datafusion
<div class="mermaid">
    ```mermaid
        flowchart TD
        A[&quot;ProjectionExec&lt;br&gt;---&lt;br&gt;avg_yearly:&lt;br&gt;CAST(sum(l_extendedprice) AS Float64) &#x2F; 7&quot;]
        B[&quot;AggregateExec&lt;br&gt;---&lt;br&gt;aggr: sum(l_extendedprice)&lt;br&gt;mode: Single&quot;]
        C[&quot;HashJoinExec&lt;br&gt;---&lt;br&gt;on: (p_partkey = l_partkey)&lt;br&gt;5526rows, build: 50ms join: 5ms&quot;]
        D[&quot;HashJoinExec&lt;br&gt;---&lt;br&gt;on: (l_partkey = p_partkey)&quot;&lt;br&gt;61385rows, build: 1.92s, join: 11ms]
        E[&quot;ProjectionExec&lt;br&gt;---&lt;br&gt;exprs:&lt;br&gt;0.2 * avg(l_quantity)&lt;br&gt;l_partkey&lt;br&gt;2m rows, 15ms&quot;]
        F[&quot;AggregateExec&lt;br&gt;---&lt;br&gt;aggr: avg(l_quantity)&lt;br&gt;group_by: l_partkey&lt;br&gt;mode: Single&lt;br&gt;2m rows, 2.553s&quot;]
        G[&quot;DataSourceExec&lt;br&gt;---&lt;br&gt;files: 1&lt;br&gt;format: parquet&lt;br&gt;59.9m rows 1.03s&quot;]
        H[&quot;FilterExec&lt;br&gt;---&lt;br&gt;predicate:&lt;br&gt;p_brand = Brand#23&lt;br&gt;AND&lt;br&gt;p_container = MED BOX&lt;br&gt;2044rows, 11ms&quot;]
        I[&quot;DataSourceExec&lt;br&gt;---&lt;br&gt;files: 1&lt;br&gt;format: parquet&lt;br&gt;predicate applied&lt;br&gt;2m rows, 24.9ms&quot;]
        J[&quot;DataSourceExec&lt;br&gt;---&lt;br&gt;files: 1&lt;br&gt;format: parquet &lt;br&gt;59.9m rows, 500ms&quot;]

        A --&gt; B
        B --&gt; C
        C --&gt; D
        C --&gt; E
        D --&gt; G
        D --&gt; H
        H --&gt; I
        E --&gt; F
        F --&gt; J
     ```
</div>
<ul>
<li>两个耗时的算子： aggregate 2.553s,  hashjoin: 1.92s(JOIN顺序不忧)</li>
</ul>
</li>
<li>duckdb
<div class="mermaid">
    ```mermaid
      flowchart TD
      A1[&quot;Total Time: 4.55s&quot;]
      A2[&quot;QUERY&quot;]
      A3[&quot;EXPLAIN_ANALYZE&lt;br&gt;────────────────────&lt;br&gt;0 Rows&lt;br&gt;(0.00s)&quot;]
      A4[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;avg_yearly&lt;br&gt;&lt;br&gt;1 Rows&lt;br&gt;(0.00s)&quot;]
      A5[&quot;UNGROUPED_AGGREGATE&lt;br&gt;────────────────────&lt;br&gt;Aggregates: sum(#0)&lt;br&gt;&lt;br&gt;1 Rows&lt;br&gt;(0.00s)&quot;]
      A6[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;l_extendedprice&lt;br&gt;&lt;br&gt;5526 Rows&lt;br&gt;(0.00s)&quot;]
      A7[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;#2&lt;br&gt;&lt;br&gt;5526 Rows&lt;br&gt;(0.00s)&quot;]
      A8[&quot;FILTER&lt;br&gt;────────────────────&lt;br&gt;(CAST(l_quantity AS DOUBLE&lt;br&gt;) &lt; SUBQUERY)&lt;br&gt;&lt;br&gt;5526 Rows&lt;br&gt;(0.00s)&quot;]
      A9[&quot;RIGHT_DELIM_JOIN&lt;br&gt;────────────────────&lt;br&gt;Join Type: RIGHT&lt;br&gt;&lt;br&gt;Conditions:&lt;br&gt;p_partkey IS NOT DISTINCT&lt;br&gt;FROM p_partkey&lt;br&gt;&lt;br&gt;Delim Index: 1&lt;br&gt;&lt;br&gt;0 Rows&lt;br&gt;(0.00s)&quot;]
      B1[&quot;HASH_JOIN&lt;br&gt;────────────────────&lt;br&gt;Join Type: INNER&lt;br&gt;&lt;br&gt;Conditions:&lt;br&gt;l_partkey = p_partkey&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.28s)&quot;]
      B2[&quot;HASH_JOIN&lt;br&gt;────────────────────&lt;br&gt;Join Type: RIGHT&lt;br&gt;&lt;br&gt;Conditions:&lt;br&gt;p_partkey IS NOT DISTINCT&lt;br&gt;FROM p_partkey&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.00s)&quot;]
      B3[&quot;HASH_GROUP_BY&lt;br&gt;────────────────────&lt;br&gt;Groups: #0&lt;br&gt;&lt;br&gt;2044 Rows&lt;br&gt;(0.00s)&quot;]
      C1[&quot;TABLE_SCAN&lt;br&gt;────────────────────&lt;br&gt;Function:&lt;br&gt;READ_PARQUET&lt;br&gt;&lt;br&gt;Projections:&lt;br&gt;l_partkey&lt;br&gt;l_quantity&lt;br&gt;l_extendedprice&lt;br&gt;&lt;br&gt;Total Files Read: 1&lt;br&gt;&lt;br&gt;59905251 Rows&lt;br&gt;(2.20s)&quot;]
      C2[&quot;TABLE_SCAN&lt;br&gt;────────────────────&lt;br&gt;Function:&lt;br&gt;READ_PARQUET&lt;br&gt;&lt;br&gt;Projections:&lt;br&gt;p_partkey&lt;br&gt;&lt;br&gt;Filters:&lt;br&gt;p_brand=&#x27;Brand#23&#x27;&lt;br&gt;p_container=&#x27;MED BOX&#x27;&lt;br&gt;&lt;br&gt;Total Files Read: 1&lt;br&gt;&lt;br&gt;2044 Rows&lt;br&gt;(1.17s)&quot;]
      D2[&quot;DUMMY_SCAN&lt;br&gt;────────────────────&lt;br&gt;&lt;br&gt;0 Rows&lt;br&gt;(0.00s)&quot;]
      E1[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;(0.2 * avg(l_quantity))&lt;br&gt;p_partkey&lt;br&gt;&lt;br&gt;2044 Rows&lt;br&gt;(0.00s)&quot;]
      E2[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;__internal_decompress_integral_bigint(#0, 1)&lt;br&gt;#1&lt;br&gt;&lt;br&gt;2044 Rows&lt;br&gt;(0.00s)&quot;]
      E3[&quot;HASH_GROUP_BY&lt;br&gt;────────────────────&lt;br&gt;Groups: #0&lt;br&gt;Aggregates: avg(#1)&lt;br&gt;&lt;br&gt;2044 Rows&lt;br&gt;(0.00s)&quot;]
      E4[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;p_partkey&lt;br&gt;l_quantity&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.00s)&quot;]
      E5[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;#0&lt;br&gt;__internal_compress_integral_l_uinteger(#1, 1)&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.00s)&quot;]
      E6[&quot;PROJECTION&lt;br&gt;────────────────────&lt;br&gt;l_quantity&lt;br&gt;p_partkey&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.00s)&quot;]
      E7[&quot;HASH_JOIN&lt;br&gt;────────────────────&lt;br&gt;Join Type: INNER&lt;br&gt;&lt;br&gt;Conditions:&lt;br&gt;l_partkey = p_partkey&lt;br&gt;&lt;br&gt;61385 Rows&lt;br&gt;(0.27s)&quot;]
      F1[&quot;TABLE_SCAN&lt;br&gt;────────────────────&lt;br&gt;Function:&lt;br&gt;READ_PARQUET&lt;br&gt;&lt;br&gt;Projections:&lt;br&gt;l_partkey&lt;br&gt;l_quantity&lt;br&gt;&lt;br&gt;Total Files Read: 1&lt;br&gt;&lt;br&gt;59905251 Rows&lt;br&gt;(0.57s)&quot;]
      F2[&quot;DELIM_SCAN&lt;br&gt;────────────────────&lt;br&gt;Delim Index: 1&lt;br&gt;&lt;br&gt;0 Rows&lt;br&gt;(0.00s)&quot;]

      A1 --&gt; A2
      A2 --&gt; A3
      A3 --&gt; A4
      A4 --&gt; A5
      A5 --&gt; A6
      A6 --&gt; A7
      A7 --&gt; A8
      A8 --&gt; A9
      A9 --&gt; B1
      A9 --&gt; B2
      A9 --&gt; B3
      B1 --&gt; C1
      B1 --&gt; C2

      B2 --&gt; E1
      B2 --&gt; D2
      E1 --&gt; E2
      E2 --&gt; E3
      E3 --&gt; E4
      E4 --&gt; E5
      E5 --&gt; E6
      E6 --&gt; E7
      E7 --&gt; F1
      E7 --&gt; F2
     ```
</div></li>
</ul>
<h2 id="query-18-duckdb-3-495s-vs-datafusion-9-567s">Query 18:  duckdb: 3.495s vs datafusion: 9.567s</h2>
<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#b48ead;">select</span><span>	c_name,	c_custkey,	o_orderkey,	o_orderdate,	o_totalprice,	</span><span style="color:#96b5b4;">sum</span><span>(l_quantity)
</span><span style="color:#b48ead;">from</span><span>	customer,	orders,	lineitem
</span><span style="color:#b48ead;">where	
</span><span>    o_orderkey in (
</span><span>        </span><span style="color:#b48ead;">select</span><span>	l_orderkey	</span><span style="color:#b48ead;">from</span><span>	lineitem	</span><span style="color:#b48ead;">group by</span><span>	l_orderkey having	</span><span style="color:#96b5b4;">sum</span><span>(l_quantity) &gt; </span><span style="color:#d08770;">300
</span><span>    )	
</span><span>    and c_custkey = o_custkey	and o_orderkey = l_orderkey
</span><span style="color:#b48ead;">group by</span><span>	c_name,	c_custkey,	o_orderkey,	o_orderdate,	o_totalprice
</span><span style="color:#b48ead;">order by</span><span>	o_totalprice </span><span style="color:#b48ead;">desc</span><span>,	o_orderdate
</span></code></pre>
<ul>
<li>duckdb<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span>  let a = (</span><span style="color:#b48ead;">select</span><span>	l_orderkey	</span><span style="color:#b48ead;">from</span><span>	lineitem	</span><span style="color:#b48ead;">group by</span><span>	l_orderkey having	</span><span style="color:#96b5b4;">sum</span><span>(l_quantity) &gt; </span><span style="color:#d08770;">300</span><span>)
</span><span>  let b = lineitem </span><span style="color:#b48ead;">inner join</span><span>(
</span><span>              (orders </span><span style="color:#b48ead;">inner join</span><span> a on </span><span style="color:#d08770;">orders</span><span>.</span><span style="color:#d08770;">o_orderkey </span><span>= </span><span style="color:#d08770;">a</span><span>.</span><span style="color:#d08770;">o_orderkey</span><span>) 
</span><span>              </span><span style="color:#b48ead;">inner join</span><span> customers c on </span><span style="color:#d08770;">o</span><span>.</span><span style="color:#d08770;">custkey </span><span>= </span><span style="color:#d08770;">c</span><span>.</span><span style="color:#d08770;">custkey 
</span><span>          )
</span></code></pre>
</li>
<li>datafusion<pre data-lang="sql" style="background-color:#2b303b;color:#c0c5ce;" class="language-sql "><code class="language-sql" data-lang="sql"><span>let a = (</span><span style="color:#b48ead;">select</span><span> l_orderkey, </span><span style="color:#96b5b4;">sum</span><span>(l_quanitity) </span><span style="color:#b48ead;">from</span><span> lineitem </span><span style="color:#b48ead;">group by </span><span style="color:#d08770;">1 </span><span>having </span><span style="color:#96b5b4;">sum</span><span>(l_quanitity))
</span><span>let b = (lineitem  </span><span style="color:#b48ead;">inner join</span><span> (orders </span><span style="color:#b48ead;">inner join</span><span> customer))
</span><span>b semi </span><span style="color:#b48ead;">join</span><span> a
</span></code></pre>
<ul>
<li><input disabled="" type="checkbox"/>
BUG: set datafusion.execution.coalesce_batches = false; 执行该SQL 语句会超时</li>
</ul>
</li>
<li>结论：duckdb 对 JOIN 顺序进行了更优的优化，在这个查询中，将具有更好筛选作用的 o_orderkey in subquery 重组顺序后，使得尽早的减少了数据量，将查询大大加速。</li>
</ul>
<p>后续将对其他 Case 进行性能对比分析。</p>
<blockquote>
<ol>
<li>datafusion explain format = tree 时，HashJoin 按照 build-side, probe-side 的左右顺序。</li>
<li>datafusion explain format = indent 时，HashJoin 按着 build-side, probe-side 的上下顺序</li>
</ol>
</blockquote>
<h1 id="jie-lun-datafusion-xing-neng-de-zhu-yao-yin-su">结论： datafusion 性能的主要因素</h1>
<ol>
<li>CoalesceBatchExec 带来的额外开销. 参考 TPCH-Query1</li>
<li>公共表达式提取优化不够:  TPCH-Query1, ClickBench-Query30</li>
<li>对 <code>select * from ... limit 10</code> 这样的查询，查询计划不够优化，导致了大量的数据扫描。 ClickBench-Query24</li>
<li>对表达式求值，datafusion 的执行效率远低于 duckdb（~25%）。这个需要进一步核实，对比，在大数据量下对性能有普遍性的影响。</li>
<li>JOIN 的性能
<ul>
<li>duckdb 生成了更合理的 JOIN 顺序，包括
<ul>
<li>选择数据量更小的边作为 build-side</li>
<li>重排 JOIN 的顺序，使得具有更好筛选作用的 JOIN 提前执行。 TPCH-18</li>
</ul>
</li>
<li>hashjoin 算子的执行效率不如 duckdb。</li>
<li>duckdb 支持 Dynamic Filter PushDown 优化，在一些场景下，可以大幅度提升性能</li>
</ul>
</li>
</ol>
<ul>
<li><input disabled="" type="checkbox"/>
如果能够提供对表达式求值的性能统计信息，对定位性能会有更好的帮助</li>
<li><input disabled="" type="checkbox"/>
datafusion 的 explain analyze 不能以 tree 的方式显示，可阅读性弱于 duckdb，理解耗时需要消耗更多时间。</li>
</ul>
<h1 id="datafusion-wen-zhang-xi-lie">datafusion 文章系列</h1>
<ol>
<li><a href="https://wangzaixiang.github.io/blog/duck-push-vs-datafusion-pull/">push vs pull</a></li>
<li><a href="https://wangzaixiang.github.io/blog/datafusion-hashjoin/">datafusion hashjoin executor</a></li>
<li><a href="https://wangzaixiang.github.io/blog/datafusion-window-function/">datafusion window function executor</a></li>
<li><a href="https://wangzaixiang.github.io/blog/datafusion-performance/">datafusion performance</a></li>
</ol>

        </article>

        <nav style="display: flex; justify-content: space-between">
          
          <a href="https://wangzaixiang.github.io/blog/analysis-sql-extensions/"> ⇦ Previous </a>
          

          
          <a href="https://wangzaixiang.github.io/blog/datafusion-window-function/"> Next ⇨ </a>
          
        </nav>

      </div>
    </div>
  </div>
</div>


  
    
<footer class="footer text-muted">
	<div class="container">
		<div class="row">
			<div class="col-lg-8 order-last order-lg-first">
				<ul class="list-inline">
					
					    <!--
						<li class="list-inline-item">Powered by <a href="https://www.netlify.com/">Netlify</a>, <a href="https://www.getzola.org/">Zola</a>, and <a href="https://github.com/aaranxu/adidoks">AdiDoks</a></li>
						-->
					
				</ul>
			</div>
			<div class="col-lg-8 order-first order-lg-last text-lg-end">
				<ul class="list-inline">
					
				</ul>
			</div>
		</div>
	</div>
</footer>

  

  
<script type="text/javascript" src="https://wangzaixiang.github.io/js/main.js" defer></script>

  <script type="text/javascript" src="https://wangzaixiang.github.io/plugins/elasticlunr.min.js" defer></script>
  <script type="text/javascript" src="https://wangzaixiang.github.io/search_index.en.js" defer></script>
  <script type="text/javascript" src="https://wangzaixiang.github.io/js/search.js" defer></script>


  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <script type="module">
    let elems = document.querySelectorAll("div.mermaid");
    elems.forEach(function(it) {
      it.innerHTML = it.innerHTML.replace("```mermaid", "").replace("```", "");
    });
    let theme = document.querySelector("body").classList.contains("dark") ? "dark" : "default";
    mermaid.initialize({startOnLoad: false, theme});
    await mermaid.run( { querySelector: '.mermaid' } );
    elems.forEach( it => it.style.width = "80%" );
  </script>
</body>
</html>
