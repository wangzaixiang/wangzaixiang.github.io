<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
    <style>
      body { font-family: sans-serif; }
      #view { margin-bottom: 20px; }
      button { padding: 8px 16px; font-size: 14px; cursor: pointer; }
    </style>
  </head>
  <body>
    <h1>Vega Incremental Update Test</h1>
    <div id="view"></div>
    <div>
      <button onclick="addData()">Add Data (D: 60)</button>
      <button onclick="updateData()">Update Data (B -> 100)</button>
      <button onclick="removeData()">Remove Data (A)</button>
    </div>

    <script>
      const spec = {
        "$schema": "https://vega.github.io/schema/vega/v5.json",
        "width": 400,
        "height": 200,
        "padding": 5,

        "data": [
          {
            "name": "table",
            "values": [
              {"category": "A", "amount": 28},
              {"category": "B", "amount": 55},
              {"category": "C", "amount": 43}
            ]
          }
        ],

        "scales": [
          {
            "name": "xscale",
            "type": "band",
            "domain": {"data": "table", "field": "category"},
            "range": "width",
            "padding": 0.05
          },
          {
            "name": "yscale",
            "domain": {"data": "table", "field": "amount"},
            "range": "height",
            "nice": true
          }
        ],

        "axes": [
          {"orient": "bottom", "scale": "xscale"},
          {"orient": "left", "scale": "yscale"}
        ],

        "marks": [
          {
            "type": "rect",
            "from": {"data": "table"},
            "encode": {
              "enter": {
                "x": {"scale": "xscale", "field": "category"},
                "width": {"scale": "xscale", "band": 1},
                "y": {"scale": "yscale", "field": "amount"},
                "y2": {"scale": "yscale", "value": 0},
                "fill": {"value": "steelblue"}
              },
              "update": {
                "x": {"scale": "xscale", "field": "category"},
                "width": {"scale": "xscale", "band": 1},
                "y": {"scale": "yscale", "field": "amount"},
                "y2": {"scale": "yscale", "value": 0},
                "fill": {"value": "steelblue"} 
              }
            }
          }
        ]
      };

      // let view;

      // vega.embed('#view', spec).then(res => {
      //   view = res.view;
      //   console.log('View loaded');
      //   // Expose view to window for console debugging
      //   window.view = view;
      //   window.vega = vega;
      // });

      function render(spec) {
        let view = new vega.View(vega.parse(spec), {
          renderer:  'canvas',  // renderer (canvas or svg)
          container: '#view',   // parent DOM container
          hover:     true       // enable hover processing
        });
        window.view = view;
        window.vega = vega;
        return view.runAsync();
      }

      function addData() {
        console.log('Adding data...');
        view.change('table', vega.changeset().insert([
          {"category": "D", "amount": 60}
        ])).run();
      }

      function updateData() {
        console.log('Updating data...');
        view.change('table', vega.changeset().modify(
          datum => datum.category === 'B',
          "amount",
          100
        )).run();
      }

      function removeData() {
        console.log('Removing data...');
        view.change('table', vega.changeset().remove(
          datum => datum.category === 'A'
        )).run();
      }

      render(spec);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  </body>
</html>