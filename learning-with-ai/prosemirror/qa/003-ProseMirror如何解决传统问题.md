# ProseMirror 如何解决传统富文本编辑器的问题

既然我们了解了浏览器富文本编辑器的基础技术及其局限性，现在我们来看看 ProseMirror 是如何解决这些问题的。ProseMirror 通过一套完全不同的设计哲学，克服了传统 `contenteditable` 编辑器在 DOM 结构、状态管理和跨浏览器兼容性方面的挑战。

ProseMirror 核心思想是**将文档内容与 DOM 表示解耦，并严格控制文档的状态变化**。

## 1. 结构化文档模型 (Schema & Nodes) 替代混乱的 DOM

*   **问题**: 传统 `contenteditable` 编辑器最大的痛点在于浏览器自动生成的 DOM 结构混乱、不一致，难以预测和控制。
*   **ProseMirror 的解决方案**:
    *   **抽象文档树**: ProseMirror 不直接将 DOM 作为文档的权威表示。相反，它维护一个**独立的、高度结构化的文档模型**，由 `Node` 对象组成的树形结构。
    *   **Schema (模式)**: 开发者需要为编辑器定义一个 `Schema`。这个 Schema 严格规定了文档中允许存在哪些类型的节点（例如：`paragraph`, `heading`, `image`, `bold` mark等），以及它们之间的嵌套关系和属性。
        *   **数学类比**: Schema 可以看作是文档结构的一种**形式语法**或**类型系统**。它定义了一个合法的文档状态空间，确保任何时候文档都处于一个可预测和一致的结构中。
    *   **严格控制**: 所有的编辑操作都是针对这个抽象文档树进行的，而不是直接操作 DOM。这意味着编辑器始终能够保持文档结构的整洁和规范，避免了浏览器引入的冗余标签或非法嵌套。

## 2. 不可变状态 (Immutable State) 与事务 (Transactions) 替代直接 DOM 操作

*   **问题**: 传统编辑器直接修改 DOM，导致状态难以追踪、撤销重做复杂、协作编辑困难。
*   **ProseMirror 的解决方案**:
    *   **单一、不可变的 EditorState**: 编辑器的全部状态（包括文档内容、光标位置、选区、插件数据等）被封装在一个单一的 `EditorState` 对象中。这个对象是**不可变的**。
    *   **事务 (Transaction)**: 任何对编辑器的修改（无论是用户输入还是程序触发）都不会直接修改当前的 `EditorState`。相反，所有的修改都被封装成一个 `Transaction` 对象。
        *   **状态转移**: 将一个 `Transaction` 应用到当前的 `EditorState` (`State_n`)，会生成一个新的 `EditorState` (`State_{n+1}`)。旧的 `State_n` 保持不变。
        *   **数学类比**: 这类似于函数式编程中的纯函数，或者区块链中的账本。每次状态变更都是一个有记录的、可重放的事件。
    *   **可追踪性与可预测性**: 不可变状态和事务机制提供了强大的优势：
        *   **撤销/重做**: 轻松实现可靠的撤销/重做功能，只需记录和反转 Transaction 序列。
        *   **协作编辑**: 允许多个客户端通过交换和合并 Transaction 来同步文档，因为 Transaction 是可序列化的，并且可以被转换（transform）以解决冲突。
        *   **调试**: 每次状态变更都有清晰的记录，极大地简化了调试过程。

## 3. 模块化与可扩展架构 替代 `execCommand` 的局限性

*   **问题**: `document.execCommand()` 功能固定、行为不透明，难以自定义。
*   **ProseMirror 的解决方案**:
    *   **完全由 JavaScript 控制**: ProseMirror 不依赖 `execCommand`。所有编辑行为都通过 JavaScript 来实现，并作为**插件**或**命令**（Commands）集成到编辑器中。
    *   **精细控制 DOM 渲染**: `prosemirror-view` 模块负责将内部的文档模型映射到浏览器 DOM，并监听 DOM 事件。但所有的 DOM 渲染和事件处理都在 ProseMirror 的控制之下，它可以智能地只更新 DOM 中发生变化的部分。
    *   **高度可定制**: 由于其模块化的设计，开发者可以替换或扩展几乎所有部分，从文档 Schema 到视图渲染，再到键盘快捷键和命令行为。这使得构建高度定制化的编辑器成为可能。

## 总结

ProseMirror 通过**解耦内容与表示、采用严格的结构化数据模型、推崇不可变状态和事务性更新**，从根本上解决了传统浏览器富文本编辑器的痛点。它提供了一个强大、灵活且可预测的平台，用于构建复杂的富文本编辑体验。
